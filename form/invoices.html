<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Invoices</h1>
        <div id="filter">
            <label for="year">Year:</label>
            <input type="text" id="year" placeholder="Enter year (optional)">
            <label for="month">Month:</label>
            <input type="text" id="month" placeholder="Enter month (optional)">
            <label for="day">Day:</label>
            <input type="text" id="day" placeholder="Enter day (optional)">
            <button id="filter-btn">Filter</button>
        </div>

        <h2>Invoice List</h2>
        <table id="invoice-list">
            <thead>
                <tr>
                    <th>Invoice Number</th>
                    <th>Client Name</th>
                    <th>Subtotal</th>
                    <th>VAT</th>
                    <th>Stamp Price</th>
                    <th>Total Price</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Invoice rows will be dynamically added here -->
            </tbody>
        </table>

        <!-- Loading Indicator -->
        <div id="loading" style="display: none;">
            <img src="loading.gif" alt="Loading..." />
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const invoiceList = document.getElementById("invoice-list").getElementsByTagName("tbody")[0];
            const filterBtn = document.getElementById("filter-btn");
            const loadingIndicator = document.getElementById("loading");

            // Show loading indicator
            function showLoading() {
                loadingIndicator.style.display = "block";
            }

            // Hide loading indicator
            function hideLoading() {
                loadingIndicator.style.display = "none";
            }

            // Get current year and month
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-based

            // Set default values for year and month if not provided
            document.getElementById("year").value = currentYear;
            document.getElementById("month").value = currentMonth < 10 ? "0" + currentMonth : currentMonth; // Format as "01", "02", etc.

            // Fetch invoices based on optional filters
            async function fetchInvoices(year = currentYear, month = currentMonth, day = '') {
                showLoading();

                // Construct the URL based on the parameters provided
                let url = '/invoices?';
                if (year) url += `year=${year}&`;
                if (month) url += `month=${month}&`;
                if (day) url += `day=${day}&`;

                // Remove any trailing "&" from the URL
                url = url.replace(/&$/, '');

                try {
                    const response = await fetch(`http://127.0.0.1:8123${url}`);
                    if (!response.ok) {
                        throw new Error("Failed to fetch invoices");
                    }
                    const invoices = await response.json();
                    populateInvoices(invoices);
                } catch (error) {
                    console.error(error);
                    alert("Error fetching invoices.");
                } finally {
                    hideLoading();
                }
            }

            // Populate invoices in the table
            function populateInvoices(invoices) {
                invoiceList.innerHTML = ''; // Clear existing rows
                invoices.forEach(invoice => {
                    const row = invoiceList.insertRow();
                    row.innerHTML = `
                        <td>${invoice.invoice_number}</td>
                        <td>${invoice.client_name}</td>
                        <td>${invoice.subtotal_ht} TND</td>
                        <td>${invoice.montant_tva} TND</td>
                        <td>${invoice.timbre_price} TND</td>
                        <td>${invoice.final_price} TND</td>
                        <td>
                            <a href="/view_invoice/${invoice.invoice_number}">
                                <img src="view-icon.svg" alt="View" class="action-icon">
                            </a>
                            <a href="/download_invoice/${invoice.invoice_number}">
                                <img src="download-icon.svg" alt="Download" class="action-icon">
                            </a>
                            <button class="delete-btn" data-invoice-number="${invoice.invoice_number}">
                                <img src="delete-icon.svg" alt="Delete" class="action-icon">
                            </button>
                        </td>
                    `;
                });

                // Add event listener for delete buttons
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const invoiceNumber = event.target.dataset.invoiceNumber;
                        deleteInvoice(invoiceNumber);
                    });
                });
            }

            // Delete an invoice by invoice number
            async function deleteInvoice(invoiceNumber) {
                showLoading();
                try {
                    const response = await fetch(`http://127.0.0.1:8123/delete_invoice?invoice_number=${invoiceNumber}`, {
                        method: "DELETE",
                    });
                    if (!response.ok) {
                        throw new Error("Failed to delete invoice");
                    }
                    const result = await response.json();
                    alert(result.message);
                    fetchInvoices(); // Refresh the list of invoices
                } catch (error) {
                    console.error(error);
                    alert("Error deleting invoice.");
                } finally {
                    hideLoading();
                }
            }

            // Initial fetch of invoices for the current month and year
            fetchInvoices(currentYear, currentMonth);

            // Filter invoices based on input
            filterBtn.addEventListener("click", () => {
                const year = document.getElementById("year").value.trim();
                const month = document.getElementById("month").value.trim();
                const day = document.getElementById("day").value.trim();
                fetchInvoices(year, month, day);
            });
        });
    </script>
</body>
</html>
